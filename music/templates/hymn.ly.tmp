\version "2.22.1"

{%- macro partmaker(sections, name, clef, relpitch, make_title=False) %}
\relative {{ relpitch }} {
\clef "{{ clef }}" \numericTimeSignature\time {{ time_signature }} \key {{ key }}
{%- set doublebar = joiner('\\bar "||"') %}
{%- for section in sections %}
{%- if not loop.first and "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ doublebar() }}
{%- if make_title and "title" in section.keys() %}\mark "{{ section.title }}"{% endif %}
{%- if "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ section[name] }}
{%- endfor %} \bar "|."
}
{%- endmacro %}

{%- macro voices_with_ambitus(voice_one_name, voice_two_name) %}
\context Voice { \partCombine \{{ voice_one_name }} \{{ voice_two_name }} }
\context NullVoice = "{{ voice_one_name }}" \with { \consists "Ambitus_engraver" } {
  \override Ambitus.X-offset = #0.0
  \{{ voice_one_name }}
}
\context NullVoice = "{{ voice_two_name }}" \with { \consists "Ambitus_engraver" } {
  \override Ambitus.X-offset = #2.0
  \{{ voice_two_name }}
}
{%- endmacro %}

{{ tag }}Soprano = {{ partmaker(sections, "soprano", "treble", "es'", True) }}

{{ tag }}Alto = {{ partmaker(sections, "alto", "treble", "c'") }}

{{ tag }}Tenor = {{ partmaker(sections, "tenor", "bass", "g") }}

{{ tag }}Bass = {{ partmaker(sections, "bass", "bass", "d") }}

\tocItem \markup "{{ title | trim }}"
\score {
    \header {
        title = "{{ title | trim }}"
        {% if subtitle is defined %}
        subtitle = "{{ subtitle | trim }}"
        {% endif %}
        {% if poet is defined %}
        poet = "{{ poet | trim }}"
        {% endif %}
        {% if composer is defined %}
        composer = "{{ composer | trim }}"
        {% endif %}
    }
    <<
        \new ChoirStaff <<
        \new Staff \with { printPartCombineTexts = ##f } <<
		{{ voices_with_ambitus(tag + "Soprano", tag + "Alto") }}

		{% for verse_index in range(num_verses) %}
                \new Lyrics \lyricsto "{{ tag }}Soprano" {
                  {% if num_verses > 1 %}
                  \set stanza = "{{ verse_index+1 }}."
                  {% endif %}
                  \lyricmode {
		    {% for section in sections %}
                    {{ section.lyrics[verse_index] }}
		    {% endfor %}
                  }
                }
		{% endfor %}
        >>
        \new Staff \with { printPartCombineTexts = ##f } <<
		{{ voices_with_ambitus(tag + "Tenor", tag + "Bass") }}
        >>
    >>
    >>
}

