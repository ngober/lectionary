\version "2.22.1"

{{ tag }}Soprano = \relative es' {
\clef "treble" \numericTimeSignature\time {{ time_signature }} \key {{ key }} |
{% set doublebar = joiner('\\bar "||"') %}
{% for section in sections %}
{% if not loop.first and "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ doublebar() }}
{% if "title" in section.keys() %}\mark "{{ section.title }}"{% endif %}
{% if "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ section.soprano }}
{% endfor %} \bar "|."
}

{{ tag }}Alto = \relative c' {
\clef "treble" \numericTimeSignature\time {{ time_signature }} \key {{ key }} |
{% set doublebar = joiner('\\bar "||"') %}
{% for section in sections %}
{% if not loop.first and "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ doublebar() }}
{% if "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ section.alto }}
{% endfor %} \bar "|."
}

{{ tag }}Tenor = \relative g {
\clef "bass" \numericTimeSignature\time {{ time_signature }} \key {{ key }} |
{% set doublebar = joiner('\\bar "||"') %}
{% for section in sections %}
{% if not loop.first and "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ doublebar() }}
{% if "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ section.tenor }}
{% endfor %} \bar "|."
}

{{ tag }}Bass = \relative d {
\clef "bass" \numericTimeSignature\time {{ time_signature }} \key {{ key }} |
{% set doublebar = joiner('\\bar "||"') %}
{% for section in sections %}
{% if not loop.first and "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ doublebar() }}
{% if "anacrusis" in section.keys() %}\partial {{ section.anacrusis }}{% endif %}
{{ section.bass }}
{% endfor %} \bar "|."
}

\tocItem \markup "{{ title | trim }}"
\score {
    \header {
        title = "{{ title | trim }}"
        {% if subtitle is defined %}
        subtitle = "{{ subtitle | trim }}"
        {% endif %}
        {% if poet is defined %}
        poet = "{{ poet | trim }}"
        {% endif %}
        {% if composer is defined %}
        composer = "{{ composer | trim }}"
        {% endif %}
    }
    <<
        \new ChoirStaff <<
        \new Staff \with { printPartCombineTexts = ##f } <<
                \mergeDifferentlyDottedOn\mergeDifferentlyHeadedOn
		\context Voice { \partCombine \{{ tag }}Soprano \{{ tag }}Alto }
                \context NullVoice = "{{ tag }}Soprano" \with { \consists "Ambitus_engraver" } {
                  \override Ambitus.X-offset = #0.0
                  \voiceOne \{{ tag }}Soprano
                }
                \context NullVoice = "{{ tag }}Alto" \with { \consists "Ambitus_engraver" } {
                  \override Ambitus.X-offset = #2.0
                  \voiceTwo \{{ tag }}Alto
                }

		{% for verse_index in range(num_verses) %}
                \new Lyrics \lyricsto "{{ tag }}Soprano" {
                  {% if num_verses > 1 %}
                  \set stanza = "{{ verse_index+1 }}."
                  {% endif %}
                  \lyricmode {
		    {% for section in sections %}
                    {{ section.lyrics[verse_index] }}
		    {% endfor %}
                  }
                }
		{% endfor %}
        >>
        \new Staff <<
                \mergeDifferentlyDottedOn\mergeDifferentlyHeadedOn
		\context Voice { \partCombine \{{ tag }}Tenor \{{ tag }}Bass }
                \context NullVoice = "{{ tag }}Tenor" \with { \consists "Ambitus_engraver" } {
                  \override Ambitus.X-offset = #0.0
                  \{{ tag }}Tenor
                }
                \context NullVoice = "{{ tag }}Bass" \with { \consists "Ambitus_engraver" } {
                  \override Ambitus.X-offset = #2.0
                  \{{ tag }}Bass
                }
        >>
    >>
    >>
}

